########################
#### HOUSE PRESENCE ####
########################

## Arriving HOME/Home Alone/Startup! set presence to "Home"
- id: presence_detect_home_alone
  alias: Detect Home Alone
  trigger:
    - platform: homeassistant
      event: start
    - platform: state
      entity_id: group.presence_kareem
      to: "home"
  condition:
  - condition: and
    conditions:
    - condition: state
      entity_id: group.presence_kareem
      state: "home"
    - condition: state
      entity_id: group.presence_friends
      state: "not_home"
  action:
    - service: input_select.select_option
      data:
        entity_id: input_select.presence_house
        option: Home
    - service: homeassistant.turn_on
      entity_id: 
        - script.timed_lamp_entrance
    # - service: notify.pushbullet
    #   data:
    #     target: !secret email_target_pushbullet
    #     title: "Home alone"
    #     message: "Home alone!"

## Home with guests! set presence to "Home Guests".
- id: presence_detect_home_with_guests
  alias: Detect Home with Friends
  trigger:
    - platform: homeassistant
      event: start
    - platform: state
      entity_id: group.presence_kareem
      to: "home"
    - platform: state
      entity_id: group.presence_friends
      to: "home"
  condition:
  - condition: and
    conditions:
    - condition: state
      entity_id: group.presence_kareem
      state: "home"
    - condition: state
      entity_id: group.presence_friends
      state: "home"
  action:
    - service: input_select.select_option
      data:
        entity_id: input_select.presence_house
        option: Home Guests
    - service: notify.pushbullet
      data: 
        target: !secret email_target_pushbullet
        title: "Home with Guests"
        message: "Home with Guests!"

## Home Alone! set presence to "Home"
- id: presence_detect_home_without_guests
  alias: Detect Guests Leaving
  trigger:
    - platform: homeassistant
      event: start
    - platform: state
      entity_id: group.presence_friends
      to: "not_home"
  condition:
  - condition: and
    conditions:
    - condition: state
      entity_id: group.presence_kareem
      state: "home"
    - condition: state
      entity_id: group.presence_friends
      state: "not_home"
  action:
    - service: input_select.select_option
      data:
        entity_id: input_select.presence_house
        option: Home
    - service: notify.pushbullet
      data: 
        target: !secret email_target_pushbullet
        title: "Home alone, guests left"
        message: "Home alone, guests left!"

## Guests are HOME ALONE! set presence to "Away Guests".
- id: presence_detect_guests_home_alone
  alias: Detect Guests Home Alone
  trigger:
    - platform: homeassistant
      event: start
    - platform: state
      entity_id: group.presence_kareem
      to: "not_home"
    - platform: state
      entity_id: group.presence_friends
      to: "home"
  condition:
  - condition: and
    conditions:
    - condition: state
      entity_id: group.presence_kareem
      state: "not_home"
    - condition: state
      entity_id: group.presence_friends
      state: "home"
  action:
    - service: input_select.select_option
      data:
        entity_id: input_select.presence_house
        option: Away Guests
    - service: notify.pushbullet
      data: 
        target: !secret email_target_pushbullet
        title: "Guests HOME ALONE"
        message: "Guests HOME ALONE!"

## Nobody Home, set presence to "Away"
- id: presence_detect_leaving
  alias: Detect Leaving
  trigger:
    - platform: homeassistant
      event: start
    - platform: state
      entity_id: group.presence_kareem
      to: "not_home"
    - platform: state
      entity_id: group.presence_friends
      to: "not_home"
  condition:
  - condition: and
    conditions:
    - condition: state
      entity_id: group.presence_kareem
      state: "not_home"
    - condition: state
      entity_id: group.presence_friends
      state: "not_home"
  action:
    - service: input_select.select_option
      data:
        entity_id: input_select.presence_house
        option: Away
    - service: notify.pushbullet
      data:
        target: !secret email_target_pushbullet
        title: "Nobody Home"
        message: "Nobody Home!"

## Turn stuff off when nobody is home
- id: presence_detect_nobody_home
  alias: Detect Nobody Home
  trigger:
    - platform: state
      entity_id: input_select.presence_house
      to: Away
      for:
        minutes: 30
  action:
    - service: homeassistant.turn_off
      entity_id:
        ## Turn off OPTIMUS Triple Screens
        - !secret plug_1
        ## Turn off bedside Lamp
        - !secret plug_2
        ## Turn off Bedroom TV + Chromecast
        - !secret plug_3
        ## Turn off Livingroom TV + Chromecast
        - !secret plug_6
        # Turn off lights
        - !secret light_upstairs
        - !secret light_downstairs
        - !secret light_entrance
        - !secret light_spots_1
        - !secret light_table_1
        - !secret light_bedroom_1
        - !secret light_closet
        - !secret light_gameroom_1
    - service: notify.pushbullet
      data: 
        target: !secret email_target_pushbullet
        title: "House turning down"
        message: "House turning down!"